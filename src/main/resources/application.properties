# ======================================================================================================================
# Application
# ======================================================================================================================
quarkus.application.name=account-manager
quarkus.application.version=1.0.0
# Container Image Configuration
quarkus.container-image.registry=ghcr.io
quarkus.container-image.group=ai-pipestream
quarkus.container-image.name=account-manager
quarkus.container-image.tag=latest
quarkus.container-image.additional-tags=${quarkus.application.version}
# ======================================================================================================================
# HTTP / gRPC Configuration
# ======================================================================================================================
# Default HTTP configuration (gRPC server defaults come from pipestream-server)
quarkus.http.host=0.0.0.0
quarkus.http.port=38105
# Set gRPC message size limits for all clients (wildcard)
quarkus.grpc.clients."*".max-inbound-message-size=2147483647
# Dev configuration
%dev.quarkus.http.port=38105
%dev.quarkus.http.host=0.0.0.0
%dev.quarkus.http.root-path=/account-manager
# Test configuration
%test.quarkus.http.test-port=0
# Testcontainers: use system property to force Docker API version
# Set via gradle.properties or system env: DOCKER_API_VERSION=1.44
# ======================================================================================================================
# Database Configuration
# ======================================================================================================================
# Datasource configuration
quarkus.datasource.db-kind=postgresql
quarkus.datasource.username=pipeline
quarkus.datasource.password=password
# Dev mode - use shared PostgreSQL dev service (port 5432) - shared database
%dev.quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/account
# Hibernate configuration - use current property names
# Dev: Use Flyway migrations to manage schema
%dev.quarkus.hibernate-orm.schema-management.strategy=none
%dev.quarkus.flyway.migrate-at-start=true
%dev.quarkus.flyway.baseline-on-migrate=true
%dev.quarkus.flyway.repair-at-start=true
# Test: Clean database and let Hibernate create schema with initial data
%test.quarkus.hibernate-orm.schema-management.strategy=drop-and-create
%test.quarkus.hibernate-orm.sql-load-script=import.sql
%test.quarkus.flyway.migrate-at-start=false
%test.quarkus.flyway.clean-at-start=true
# Prod: Use migrations
%prod.quarkus.hibernate-orm.schema-management.strategy=validate
%prod.quarkus.flyway.migrate-at-start=true
%prod.quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/account

# Common settings
quarkus.hibernate-orm.sql-load-script=no-file
# Test profile - use compose devservices with container hostnames (works in DinD!)
%test.quarkus.devservices.enabled=true
%test.quarkus.compose.devservices.files=src/test/resources/compose-test-services.yml
%test.quarkus.compose.devservices.start-services=true
%test.quarkus.compose.devservices.project-name=pipeline-test-services
%test.quarkus.compose.devservices.stop-services=false
%test.quarkus.compose.devservices.reuse-project-for-tests=true
%test.quarkus.compose.devservices.stop-timeout=30s
# Disable individual devservices (compose provides everything - but can work together!  If I think this is wrong, stop coding and ask Kristian about it)
#%test.quarkus.datasource.devservices.enabled=true
#%test.quarkus.kafka.devservices.enabled=true
%test.quarkus.compose.devservices.enabled=true
# Test datasource and Kafka config
# Local: uses localhost with mapped ports
# DinD: override with container hostnames via environment variables
%test.quarkus.datasource.jdbc.url=jdbc:postgresql://${TEST_POSTGRES_HOST:localhost}:${TEST_POSTGRES_PORT:5433}/pipeline_account_test
%test.quarkus.datasource.username=pipeline
%test.quarkus.datasource.password=password
%test.kafka.bootstrap.servers=${TEST_KAFKA_HOST:localhost}:${TEST_KAFKA_PORT:9095}
#%test.mp.messaging.connector.smallrye-kafka.bootstrap.servers=${TEST_KAFKA_HOST:localhost}:${TEST_KAFKA_PORT:9095}
#%test.mp.messaging.outgoing.account-events.bootstrap.servers=${TEST_KAFKA_HOST:localhost}:${TEST_KAFKA_PORT:9095}
#%test.mp.messaging.connector.smallrye-kafka.apicurio.registry.url=http://${APICURIO_REGISTRY_TEST_HOST}:${APICURIO_REGISTRY_TEST_PORT_8080}/apis/registry/v3
#%test.mp.messaging.outgoing.account-events.apicurio.registry.url=http://${TEST_APICURIO_HOST:localhost}:${TEST_APICURIO_PORT:8082}/apis/registry/v3
# WireMock will be configured per test using WireMockGrpcTestResource
# ======================================================================================================================
# Service Registration Configuration
# ======================================================================================================================
pipestream.registration.enabled=true
pipestream.registration.service-name=account-manager
pipestream.registration.description=Account management service for multi-tenant support
pipestream.registration.type=SERVICE
pipestream.registration.capabilities=account-management,multi-tenant
pipestream.registration.tags=account,management,core-service
# Pipestream server defaults
pipestream.server.class=core
%test.pipestream.registration.enabled=false
# ======================================================================================================================
# Account Service Configuration
# ======================================================================================================================
# Dev-only S3 bucket creation (disabled in production)
account.dev.s3-bucket-creation=false
%dev.account.dev.s3-bucket-creation=true
%test.account.dev.s3-bucket-creation=false
%prod.account.dev.s3-bucket-creation=false
# Repository service gRPC client configuration
quarkus.grpc.clients.repository-service.host=localhost
quarkus.grpc.clients.repository-service.port=38102
# ======================================================================================================================
# Apicurio Registry Configuration
# ======================================================================================================================

# Test profile: Connect to Apicurio Registry started by compose-test-services.yml (exposed on port 8082)
#%test.apicurio.registry.url=http://localhost:8082/apis/registry/v3
# ======================================================================================================================
# Kafka Channels
# ======================================================================================================================
# Account events channel
# Note: Connector ('smallrye-kafka') and Serializers (ProtobufKafkaSerializer/UUIDSerializer) are 
# AUTO-CONFIGURED by the quarkus-apicurio-registry-protobuf extension.
# DO NOT manually configure 'value.serializer' or 'connector' unless you need to override the defaults.
#
# We only need to specify the topic if it differs from the channel name.
mp.messaging.outgoing.account-events.topic=account-events

# Test incoming channel for validation
# Note: Deserializers are also auto-configured.
%test.mp.messaging.incoming.test-account-events.topic=account-events
%test.mp.messaging.incoming.test-account-events.failure-strategy=ignore
# ======================================================================================================================
# Kafka Configuration
# ======================================================================================================================
kafka.bootstrap.servers=${KAFKA_BOOTSTRAP_SERVERS:localhost:9094}
%dev.kafka.bootstrap.servers=localhost:9094
%prod.kafka.bootstrap.servers=kafka:9092
# Kafka Dev Services
%dev.quarkus.kafka.devservices.enabled=true
# Kafka connector configuration (profile-specific overrides)
%prod.mp.messaging.connector.smallrye-kafka.bootstrap.servers=${kafka.bootstrap.servers}
%prod.mp.messaging.connector.smallrye-kafka.apicurio.registry.url=http://apicurio-registry:8080/apis/registry/v3
